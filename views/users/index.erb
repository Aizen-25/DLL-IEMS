<h1>Manage Users</h1>

<a href="/users/new" style="padding:10px 14px; background:var(--accent); color:#fff; border-radius:6px; text-decoration:none">Add New User</a>

<% if @temp_password_info %>
  <div style="margin-top:16px; padding:12px; background:#072d4b; border-left:4px solid #ffb86b; color:#eaf6ff; border-radius:6px;">
    <div style="font-weight:700">Temporary password created</div>
    <div style="margin-top:6px">User: <strong><%= @temp_password_info['username'] %></strong></div>
    <div style="margin-top:6px">Password: <code id="temp_pw_text" style="background:#001f2e; padding:6px 8px; border-radius:4px; display:inline-block"><%= @temp_password_info['password'] %></code>
      <button id="copyTempPw" class="btn-secondary" style="margin-left:8px; padding:6px 8px">Copy</button>
    </div>
    <div style="margin-top:6px; color:var(--muted); font-size:13px">This password will not be shown again. Give it securely to the user and advise them to change it at first login.</div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var btn = document.getElementById('copyTempPw');
      if(btn){
        btn.addEventListener('click', function(){
          var text = document.getElementById('temp_pw_text').innerText;
          navigator.clipboard && navigator.clipboard.writeText(text).then(function(){
            btn.innerText = 'Copied';
            setTimeout(function(){ btn.innerText = 'Copy'; }, 2000);
          }, function(){ alert('Copy failed. Select and copy the password manually.'); });
        });
      }
    });
  </script>
<% end %>

<table style="width:100%; margin-top:20px; border-collapse:collapse">
  <thead>
    <tr>
      <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1)">Username</th>
      <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1)">Role</th>
      <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1)">Status</th>
      <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1)">Actions</th>
      <th style="text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.1)">Created At</th>
    </tr>
  </thead>
  <tbody>
    <% @users.each do |user| %>
      <tr>
        <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05)">
          <% if user.respond_to?(:must_change_password) && user.must_change_password %>
            <a href="#" class="reveal-temp" data-user-id="<%= user.id %>" style="color:var(--accent); font-weight:700; text-decoration:underline"><%= user.username %></a>
          <% else %>
            <%= user.username %>
          <% end %>
        </td>
        <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05)"><%= user.role %></td>
        <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05)">
          <% if user.respond_to?(:must_change_password) && user.must_change_password %>
            <span style="background:#ffb86b; color:#000; padding:4px 8px; border-radius:6px; font-weight:600; font-size:12px">Temp password</span>
          <% else %>
            <span style="color:var(--muted); font-size:12px">OK</span>
          <% end %>
        </td>
        <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05)">
          <% if user.respond_to?(:must_change_password) && user.must_change_password %>
            <form method="post" action="/users/<%= user.id %>/force_reset" style="display:inline">
              <button type="submit" class="btn-secondary" style="padding:6px 8px">Force reset</button>
            </form>
          <% else %>
            <form method="post" action="/users/<%= user.id %>/force_reset" style="display:inline">
              <button type="submit" class="btn-secondary" style="padding:6px 8px">Require change</button>
            </form>
          <% end %>
        </td>
        <td style="padding:10px; border-bottom:1px solid rgba(255,255,255,0.05)"><%= user.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<!-- Modal for revealing temporary password -->
<div id="tempPwModal" style="display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:4000">
  <div style="background:var(--card); padding:14px; border-radius:8px; width:100%; max-width:520px; color:#eaf6ff">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <strong>Temporary password</strong>
      <button id="closeTempModal" class="btn-secondary">Close</button>
    </div>
    <div style="margin-top:10px">
      <div>User: <strong id="tp_user"></strong></div>
      <div style="margin-top:8px">Password: <code id="tp_pw" style="background:#001f2e; padding:6px 8px; border-radius:4px"></code>
        <button id="tp_copy" class="btn-secondary" style="margin-left:8px">Copy</button>
      </div>
      <div style="margin-top:8px; color:var(--muted); font-size:13px">This password is shown while the account is marked as "Temp password" and will be removed when the user updates their password.</div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.reveal-temp').forEach(function(el){
      el.addEventListener('click', async function(ev){
        ev.preventDefault();
        var id = el.dataset.userId;
        try{
          var res = await fetch('/users/' + id + '/temp_password');
          if(res.ok){
            var j = await res.json();
            document.getElementById('tp_user').innerText = j.username;
            document.getElementById('tp_pw').innerText = j.password;
            document.getElementById('tempPwModal').style.display = 'flex';
          } else {
            var txt = await res.text();
            alert('Unable to reveal password: ' + txt);
          }
        }catch(e){ alert('Failed to fetch temp password'); }
      });
    });
    var closeBtn = document.getElementById('closeTempModal');
    if(closeBtn) closeBtn.addEventListener('click', function(){ document.getElementById('tempPwModal').style.display = 'none'; });
    var tcopy = document.getElementById('tp_copy');
    if(tcopy) tcopy.addEventListener('click', function(){ var t = document.getElementById('tp_pw').innerText; navigator.clipboard && navigator.clipboard.writeText(t); tcopy.innerText='Copied'; setTimeout(()=>tcopy.innerText='Copy',1500); });
  });
</script>