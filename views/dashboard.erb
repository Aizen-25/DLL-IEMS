<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px">
  <h1 style="color:var(--accent); margin:0">Inventory Insights</h1>
  <form method="get" action="/dashboard" style="display:flex; gap:8px; align-items:center">
    <label for="year_filter" style="color:var(--muted); font-size:0.9rem">Filter by Year:</label>
    <input type="number" id="year_filter" name="year" value="<%= params['year'] || Date.today.year %>" 
           min="2000" max="<%= Date.today.year + 1 %>" 
           style="padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:var(--text); width:90px">
    <button type="submit" style="padding:6px 14px; border-radius:6px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer">Apply</button>
    <% if params['year'] %>
      <a href="/dashboard" style="padding:6px 10px; border-radius:6px; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.05); color:var(--muted); text-decoration:none; font-size:0.85rem">Clear</a>
    <% end %>
  </form>
  <!-- Serial search: quick lookup for asset tag / serial -->
  <div style="display:flex; gap:8px; align-items:center; margin-left:12px">
    <input id="serial_search" type="search" placeholder="Search serial / asset tag" aria-label="Search serial" style="padding:6px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text); width:280px">
    <button id="serial_search_btn" type="button" style="padding:6px 10px; border-radius:8px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer">Search</button>
  </div>
</div>

<style>
  .dark-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px }
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); padding:14px; border-radius:10px }
  .card.compact { padding:8px }
  .title { color:#cfeafc; margin-bottom:8px }
  .metric-big { font-size:1.6rem; color:var(--accent) }
  .muted { color:var(--muted) }
  .turnover { display:flex; gap:12px; }
  .turnover .tile { padding:10px; border-radius:8px; background: rgba(255,255,255,0.02); text-align:center }
  @media (max-width:1000px) { .dark-grid { grid-template-columns: 1fr 1fr } }
  @media (max-width:700px) { .dark-grid { grid-template-columns: 1fr } .lead-grid { grid-template-columns: 1fr } }
  /* responsive chart canvas sizing */
  .chart-canvas { width: 100%; display: block; height: 220px; }
  @media (max-width: 900px) { .chart-canvas { height: 180px } }
  @media (max-width: 480px) { .chart-canvas { height: 140px } }
  /* full-on-mobile: span full grid on narrower viewports */
  @media (max-width: 900px) {
    .dark-grid .full-on-mobile { grid-column: 1 / -1 }
  }
  .deployed-serial { cursor:text; display:inline-block; padding:2px 4px; border-radius:4px }
  .serial-match { border-left:6px solid #FFD600; padding-left:8px; background: linear-gradient(90deg, rgba(255,214,0,0.06), transparent) }
  #serial_search_results { position:absolute; background:var(--bg); border:1px solid rgba(255,255,255,0.06); padding:8px; border-radius:6px; box-shadow:0 6px 24px rgba(0,0,0,0.6); display:none; z-index:2000; max-width:420px }
  #serial_search_results .sr_row { padding:6px 8px; border-radius:6px; cursor:pointer }
  #serial_search_results .sr_row:hover { background:rgba(255,255,255,0.02) }
</style>

<div class="dark-grid">
  <div style="display:flex; gap:12px; margin-bottom:12px">
    <div class="card" style="flex:1; text-align:center">
      <div class="muted">Total Deployed</div>
      <div class="metric-big" style="font-size:2rem"><%= @total_deployed %></div>
    </div>
    <div class="card" style="flex:1; text-align:center">
      <div class="muted">Total Available Stock</div>
      <div class="metric-big" style="font-size:2rem"><%= @total_available_stock %></div>
    </div>
  </div>

  <div class="card compact full-on-mobile">
    <div class="title">Office distribution</div>
    <%= erb :'_distribution_chart', locals: { rows: @location_rows, canvas_id: nil, enable_chart: false, limit: 5 } %>
  </div>
  <div class="card compact full-on-mobile">
    <div class="title">Status</div>
    <%= erb :'_distribution_chart', locals: { rows: @status_rows, canvas_id: nil, enable_chart: false, limit: 5 } %>
  </div>
  <div class="card compact full-on-mobile">
    <div class="title">Deployed by Category</div>
    <%= erb :'_distribution_chart', locals: { rows: @deployed_by_category_rows || @deployed_by_category, canvas_id: nil, enable_chart: false, limit: 5 } %>
  </div>
  <div class="card full-on-mobile">
    <div class="title">Inventory Turnover Rate (Quarterly)</div>
    <div class="turnover">
      <% @turnover_rates.each do |q,v| %>
        <div class="tile">
          <div class="muted"><%= q %></div>
          <div class="metric-big"><%= v %>x</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<div style="margin-top:12px" class="card">
  <div class="title">Deployed Items (Top)</div>
  <% @top_deployed.each do |p| %>
    <div style="margin-bottom:8px">
      <strong><%= "#{p[:deployed]} - #{p[:name]}" %></strong>
      <div style="margin-left:8px; color:var(--muted); font-size:0.95rem">
        <% if p[:deployed_names] && p[:deployed_names].any? %>
          <% p[:deployed_names].each do |dn| %>
            <%# Wrap each serial/display line so we can highlight it from JS by serial text %>
            <div><span class="deployed-serial" data-serial="<%= ERB::Util.html_escape(dn.to_s) %>"><%= dn %></span></div>
          <% end %>
        <% else %>
          <div>No deployed details available</div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Modal: show deployment / assignee details for a serial -->
<div id="serialDetailModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1200; align-items:center; justify-content:center;">
  <div style="background:var(--bg); border:1px solid rgba(255,255,255,0.06); padding:18px; border-radius:10px; width:90%; max-width:900px; color:var(--text);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
      <strong id="sdm_title">Serial details</strong>
      <button id="sdm_close" style="background:transparent; border:none; color:var(--muted); font-size:1.2rem; cursor:pointer">âœ•</button>
    </div>
    <div id="sdm_body" style="max-height:60vh; overflow:auto; font-size:0.95rem; color:var(--text)"></div>
  </div>
</div>

<!-- Load local Chart.js vendor copy to ensure offline/blocked environments work -->
<script src="/vendor/chart.min.js"></script>
<script>
  // Lazy-init helper for charts: initialize when element is visible to save CPU on low-end devices
  function lazyInit(elementId, initFn){
    try{
      var el = document.getElementById(elementId);
      if(!el) { initFn(); return; }
      if('IntersectionObserver' in window){
        var io = new IntersectionObserver(function(entries, obs){
          entries.forEach(function(ent){ if(ent.isIntersecting){ try{ initFn(); }catch(e){} obs.unobserve(el); } });
        }, { root: null, threshold: 0.1 });
        io.observe(el);
      } else {
        // fallback: init after small timeout
        setTimeout(initFn, 120);
      }
    } catch(e){ try{ initFn(); }catch(_){ } }
  }
  // low-end heuristic: small viewport or few CPU cores
  const lowEndDevice = (window.innerWidth <= 480) || (navigator.hardwareConcurrency && navigator.hardwareConcurrency <= 2);
  // Small fail-safe canvas renderer used when Chart.js is unavailable.
  function drawBarChartFallback(canvasId, labels, data, opts) {
    try {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      // ensure computed size; do pixel-ratio scaling for crisp bars
      const ratio = window.devicePixelRatio || 1;
      const cw = Math.max(200, Math.floor((canvas.clientWidth || 600)));
      const ch = Math.max(100, Math.floor((canvas.clientHeight || 200)));
      canvas.style.display = 'block';
      canvas.width = Math.floor(cw * ratio);
      canvas.height = Math.floor(ch * ratio);
      canvas.style.width = cw + 'px';
      canvas.style.height = ch + 'px';
      const ctx = canvas.getContext('2d');
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      // clear
      ctx.clearRect(0,0,cw,ch);
      const padding = 24;
      const w = cw - padding * 2;
      const h = ch - padding * 2;
      const max = Math.max(1, ...data);
      const barGap = 12;
      const barWidth = Math.max(18, (w - (labels.length - 1) * barGap) / labels.length);
      labels.forEach(function(label, i){
        const val = data[i] || 0;
        const x = padding + i * (barWidth + barGap);
        const barH = (val / max) * (h - 20);
        const y = padding + (h - barH);
        // bar background
        ctx.fillStyle = 'rgba(255,255,255,0.06)';
        ctx.fillRect(x, padding, barWidth, h);
        // bar
        ctx.fillStyle = opts && opts.color ? opts.color : 'rgba(54,162,235,0.9)';
        ctx.fillRect(x, y, barWidth, barH);
        // label
        ctx.fillStyle = '#cfeafc';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        const tx = x + barWidth/2;
        ctx.fillText(label, tx, ch - 6);
        // value
        ctx.fillText(String(val), tx, y - 6);
      });
    } catch (e) {
      console.error('drawBarChartFallback error', e);
    }
  }

  // inventory data handled by other widgets; product-level bar and stockout gauges removed

  // Office distribution handled by server-rendered partial (no client chart required)

  
  // global client-side error capture and debug banner removed
</script>

<script>
  (function(){
    function debounce(fn, wait){ var t; return function(){ var args=arguments; clearTimeout(t); t=setTimeout(function(){ fn.apply(null,args); }, wait); }; }

    var input = document.getElementById('serial_search');
    var btn = document.getElementById('serial_search_btn');
    var modal = document.getElementById('serialDetailModal');
    var modalBody = document.getElementById('sdm_body');
    var modalTitle = document.getElementById('sdm_title');
    var modalClose = document.getElementById('sdm_close');

    function clearHighlights(){
      document.querySelectorAll('.serial-match').forEach(function(el){ el.classList.remove('serial-match'); });
    }

    function highlightSerialText(q){
      clearHighlights();
      if(!q) return;
      var norm = q.toString().trim();
      var nodes = document.querySelectorAll('.deployed-serial');
      nodes.forEach(function(n){
        try{
          var txt = n.getAttribute('data-serial') || n.textContent || '';
          if(txt && txt.toLowerCase().indexOf(norm.toLowerCase()) !== -1){
            n.classList.add('serial-match');
            // make clickable: open modal with details when clicked
            n.style.cursor = 'pointer';
            n.onclick = function(){ openDetailsForSerial(txt); };
          } else {
            n.onclick = null;
            n.style.cursor = '';
          }
        }catch(e){ }
      });
    }

    function openDetailsForSerial(serial){
      modalBody.innerHTML = '<div style="padding:12px">Loading...</div>';
      modalTitle.textContent = 'Serial: ' + serial;
      modal.style.display = 'flex';
      // query serials API to get record(s)
      fetch('/api/serials?q=' + encodeURIComponent(serial), { credentials: 'same-origin' }).then(function(r){
        if(!r.ok) throw new Error('not ok');
        return r.json();
      }).then(function(json){
        var html = [];
        if(json && json.results && json.results.length){
          json.results.forEach(function(it){
            if(it.type === 'user_equipment'){
              html.push('<div style="margin-bottom:8px"><strong>Assigned to:</strong> ' + (it.user_name || 'unknown') + ' (user id: '+ (it.user_id||'') +')');
              html.push('<div><strong>Equipment:</strong> ' + (it.equipment_name||'') + ' (' + (it.equipment_model||'') + ')</div>');
              html.push('<div><strong>Assigned:</strong> ' + (it.assigned_at || '') + ' | <strong>Returned:</strong> ' + (it.returned_at || '') + '</div>');
              if(it.request_id) html.push('<div><a href="/requests/'+it.request_id+'">Open Request #' + it.request_id + '</a></div>');
              html.push('</div>');
            } else if(it.type === 'equipment'){
              html.push('<div style="margin-bottom:8px"><strong>Asset:</strong> ' + (it.equipment_name||'') + ' (' + (it.equipment_model||'') + ')</div>');
              html.push('<div><strong>Status:</strong> ' + (it.status||'') + ' | <strong>Location:</strong> ' + (it.location||'') + '</div>');
              html.push('<div><a href="/equipments/'+it.equipment_id+'">Open Equipment</a></div>');
            } else if(it.type === 'request_note'){
              html.push('<div style="margin-bottom:8px"><strong>Request:</strong> ' + (it.requester_name||'') + ' (id: '+(it.request_id||'')+')');
              if(it.equipment_id) html.push('<div><strong>Equipment:</strong> ' + (it.equipment_name||'') + '</div>');
              if(it.notes) html.push('<div style="margin-top:6px; color:var(--muted)"><pre style="white-space:pre-wrap; font-size:0.9rem">' + (it.notes||'') + '</pre></div>');
              if(it.request_id) html.push('<div><a href="/requests/'+it.request_id+'">Open Request</a></div>');
              html.push('</div>');
            }
          });
        } else {
          html.push('<div>No details found for this serial.</div>');
        }
        modalBody.innerHTML = html.join('');
      }).catch(function(e){
        modalBody.innerHTML = '<div>Error loading details</div>';
      });
    }

    modalClose.addEventListener('click', function(){ modal.style.display = 'none'; });
    modal.addEventListener('click', function(ev){ if(ev.target === modal) modal.style.display = 'none'; });

    var doSearch = debounce(function(){ var q = input.value && input.value.trim(); if(!q){ clearHighlights(); return; } fetch('/api/serials?q=' + encodeURIComponent(q), { credentials: 'same-origin' }).then(function(res){ if(!res.ok) return []; return res.json(); }).then(function(json){ if(json && json.results && json.results.length){ highlightSerialText(q); } else { clearHighlights(); } }).catch(function(){ clearHighlights(); }); }, 300);

    input.addEventListener('input', doSearch);
    btn.addEventListener('click', function(){ var q = input.value && input.value.trim(); if(!q) return; highlightSerialText(q); openDetailsForSerial(q); });

    // also press Enter in the input to open details
    input.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); var q = input.value && input.value.trim(); if(!q) return; highlightSerialText(q); openDetailsForSerial(q); } });

  })();
</script>
