<h1>Equipment History / Tracks</h1>

<form method="get" action="/equipment_histories" style="display:flex;gap:8px;align-items:end;margin-top:12px;flex-wrap:wrap">
  <div>
    <label>Equipment</label>
    <select name="equipment_id">
      <option value="">Any</option>
      <% @equipments.each do |e| %>
        <option value="<%= e.id %>" <%= 'selected' if params['equipment_id'].to_s == e.id.to_s %>><%= e.name %> (<%= e.brand %>)</option>
      <% end %>
    </select>
  </div>
  <div>
    <label>User</label>
    <select name="user_id">
      <option value="">Any</option>
      <% @users.each do |u| %>
        <option value="<%= u.id %>" <%= 'selected' if params['user_id'].to_s == u.id.to_s %>><%= u.username %></option>
      <% end %>
    </select>
  </div>
  <div>
    <label>Serial</label>
    <input name="serial" value="<%= params['serial'] %>">
  </div>
  <div>
    <label>From</label>
    <input name="from" type="date" value="<%= params['from'] %>">
  </div>
  <div>
    <label>To</label>
    <input name="to" type="date" value="<%= params['to'] %>">
  </div>
  <div>
    <button class="btn-primary" type="submit">Filter</button>
    <a class="btn-secondary" href="/equipment_histories">Reset</a>
  </div>
</form>

<table style="width:100%; margin-top:12px">
  <thead>
    <tr>
      <th>Occurred</th>
      <th>Equipment</th>
      <th>Action</th>
      <th>User</th>
      <th>Serial</th>
      <th>Details</th>
    </tr>
  </thead>
  <tbody>
    <% if @histories.empty? %>
      <tr><td colspan="6" style="padding:12px;color:var(--muted)">No history entries found.</td></tr>
    <% else %>
      <% @histories.each do |h| %>
        <% d = h.details_hash rescue {} %>
        <tr>
          <td><%= (h.occurred_at || h.created_at) %></td>
          <td>
            <% if h.equipment %>
              <a href="/equipments/<%= h.equipment.id %>/history"><%= h.equipment.name %></a>
            <% else %>
              <%= h.equipment_id %>
            <% end %>
          </td>
          <td><%= h.action %></td>
          <td><%= h.user ? h.user.username : '-' %></td>
          <td><%= d['serial'] || '-' %></td>
          <td style="max-width:600px; white-space:pre-wrap"><%= h.details %></td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>
